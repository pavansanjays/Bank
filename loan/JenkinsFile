pipeline {
    agent {
          docker {
                image 'maven:3.9.6-eclipse-temurin-21'
                // 1. Map Jenkins cache to a unique, writable directory inside the container: /m2_cache
                args '-v /var/jenkins_home/.m2:/m2_cache'
          }
    }
    environment{
         // Variable for the artifact path
         APP_JAR='target/*.jar'
    }

    stages {
        stage('build Stage') {
            steps {
                 echo "This is the building stage"
                 dir('loan'){
                     // 2. FIX: Tell Maven where the cache is mounted using -Dmaven.repo.local
                     sh 'mvn clean install -Dmaven.repo.local=/m2_cache'
                 }
            }
        }

        stage('testing')
        {
            steps{
                echo "Running unit tests"
                dir('loan'){
                    // 3. FIX: Apply the same flag to the testing stage
                    sh 'mvn test -Dmaven.repo.local=/m2_cache'
                }
            }
        }

        stage('Archive jar file'){
           steps{
              echo "This is the archiving file stage"
              dir('loan'){
                  // The archiving step doesn't run Maven, so no flag is needed here
                  archiveArtifacts artifacts: APP_JAR
              }
           }
        }
    }
    post{
        always{
            echo"always in post"
        }
    }
}